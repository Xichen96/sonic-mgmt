##############################################################################################
### playbook to deploy the mcx switch
### Use this playbook to deploy the console configurations of mcx switch in SONiC testbed
################################################################################################
- name: Gathering lab graph facts about the device
  conn_graph_facts: host={{ inventory_hostname }}
  delegate_to: localhost
  tags: always

- name: Check that OS is SONiC
  fail: msg="Cannot confirm OS is SONiC"
  when: os is not defined or os != "sonic"

- name: Prepare mgmt device admin login info
  set_fact: ansible_ssh_user={{ mgmt_admin_user }} ansible_ssh_pass={{ mgmt_admin_password }}

- name: Backup config_db.json
  shell: cp /etc/sonic/config_db.json /etc/sonic/config_db.json.bak

- name: Generate base config
  shell: sonic-cfggen -H -k {{ device_info["HwSku"] }} -a "{\"DEVICE_METADATA\":{\"localhost\":{\"hostname\":\"{{ inventory_hostname }}\"}}}" --print-data | sed '1d;$d'
  register: base_config

- name: Move json config to console server
  template:
    src: console_config.j2
    dest: /etc/sonic/config_db.json

- name: Config
  shell: config reload -y
